\documentclass[10pt,twocolumn]{article}

\usepackage{comment}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{fullpage}
\usepackage{graphicx}
\usepackage{multicol}
\usepackage{titlesec}
\usepackage{titling}
\usepackage[font={footnotesize,sf},labelfont={sf,bf},margin=1cm]{caption}

\pretitle{\begin{flushleft}\LARGE}
\posttitle{\par\end{flushleft}\vskip 0.5em}
\preauthor{\begin{flushleft}
\lineskip 0.5em%
\begin{tabular}{l}}
\postauthor{\end{tabular}\par\end{flushleft}}
\predate{\begin{flushleft}}
\postdate{\par\end{flushleft}}
\titleformat*{\section}{\large\bfseries\sffamily}
\titleformat*{\subsection}{\normalsize\bfseries\sffamily}

\usepackage{lmodern}
%\renewcommand*\familydefault{\sfdefault}
\newcommand{\lm}{\fontfamily{\sfdefault}\selectfont}
\newcommand{\mb}{\mathbf}

\usepackage{abstract}
\renewcommand{\abstractnamefont}{\bfseries\sffamily\normalsize}
%fg\renewcommand*{\abstractname}{\flushleft\textbf{}}

\title{\LARGE \bfseries \lm Control of Underactuated Vehicular Traffic}
\author{Stanislav Nikolov\\Massachusetts Institute of Technology\\July 6, 2012}
\date{}

\newenvironment{myindentpar}[1]%
 {\begin{list}{}%
         {\setlength{\leftmargin}{#1}}%
         \item[]%
 }
 {\end{list}}

\begin{document}

\twocolumn[
  \begin{@twocolumnfalse}
\maketitle
\vspace{-55pt}
\begin{myindentpar}{0.25cm}
\item 
\begin{paragraph}
\newline\noindent{\lm\bfseries Abstract:} We study a class of control policies for the single headway \cite{Bando} and multi-anticipative \cite{Lenz} optimal velocity traffic model in which only a subset of cars are actuated. We prove the stability of these control policies and characterize their regions of attraction around the uniform traffic flow fixed point.
\end{paragraph}
\end{myindentpar}
\vspace{20pt}
\end{@twocolumnfalse}
]

% Misc stuff to talk about
% Traffic can actually smooth out by itself depending on the parameter governing the dynamics. Can show this analytically for linear dynamics, and demonstrate it for nonlinear dynamics.

% describe / motivate your system
\section{Introduction}
A recent study by the U.S. Treasury Department found that traffic in the United States wasted 1.9 billion gallons of gas. Other studies have suggested that people in the United States spent as many as 5 billion hours in traffic, resulting in as much as \$100 billion in lost productivity.

Traffic jams form for a variety of reasons. Disturbances, such as traffic accidents or road bottlenecks are a familiar and obvious cause. However, traffic jams are often observed to form spontaneously without any apparent disturbance. Even if all vehicles have the same velocity and headway (distance to the car in front), this configuration is often unstable. Drivers are not perfect, and under certain conditions, small disturbances in the headways and velocities are amplified, leading to a self-sustaining traffic jam. 

With the possibility of street-legal, self-driving robotic cars joining regular cars on the road in the near future, it is interesting to consider traffic as an underactuated dynamical system, and the problem of smoothing out traffic jams as an underactuated control problem. %PLACEMENT!!!

The theory of traffic jams has attracted a broad community of researchers and a diverse set of modeling approaches, including fluid models \cite{}, cellular automata models \cite{}, and car-following models \cite{}. Here, we focus on car-following models and the vehicle dynamics that have been proposed to reproduce self-sustaining traffic jams. Bando et al. \cite{Bando} propose the optimal velocity model (OVM) and study the local linear stability about the uniform flow steady state. However, they do not study the region of attraction around the fixed point. Peng et al. \cite{Peng} present a linear traffic model in which each vehicle regulates its headway using proportional-derivative control. Despite its ease of analysis and usefulness as a tool to study linearized dynamics, the linear model alone does not prevent negative velocities or vehicle collisions, nor does it robustly generate self-sustaining traffic jams.\footnote{The system would need modes with purely imaginary eigenvalues.}

In addition to models of the passive vehicle system, many have proposed control policies to smooth out traffic jams. Konishi et al. \cite{Konishi} studied the stability of a controlled OVM. Konishi's system is {\em fully-actuated} since one has control authority over each car. As robotic cars (such as Google's self-driving car \cite{Thrun}) being to join regular cars on the road, a more realistic scenario would be one in which the system is {\em underactuated}. In an underactuated vehicle system, one can only control a subset of {\em active} cars while the rest of the cars ({\em passive} cars) follow a given dynamics. In this work, I propose a simple control policy that stabilizes an otherwise unstable system by controlling only a subset of the cars. In another fully-actuated approach to control, Lenz et al. \cite{} consider the stabilizing effect of an OV function that takes into account multiple headways. This model also admits an underactuated version. % AND YOU'VE IMPLEMENTED IT?

\section{Car Following Model}
In order to talk about stabilizing vehicular traffic, we first present an idealized model of traffic flow. We model traffic as $N$ vehicles with positions $x_n$ and velocities $v_n$ driving counterclockwise on a single-lane circular road of circumference $L$.\footnote{A ciruclar road may be thought of as an idealization of the circuit roads around many cities.} The cars are arranged such that car $i-1$ precedes car $i$. Each car has a headway (the free space in front) of $\Delta x_n$.

To model vehicle motion, we must model a driver's reaction to her vehicle's headway, and in particular, how the driver should accelerate or decelerate in response to the headway. Bando et al \cite{Bando} outline two popular reaction models --- the optimal distance model and the optimal velocity model. In the optimal distance model, the driver tries to regulate the headway to a desired value, accelerating if too far from the car in front and decelerating if too close. In the optimal velocity model, the driver tries to maintain an optimal velocity computed from the headway, accelerating when below the optimal velocity and decelerating when above it. We will consider the latter model, which has the following equations of motion:
\begin{align}
\label{ovm1} \dot{x}_n &= v_n,& &n=1,\dots,N\\
\label{ovm2} \dot{v}_n &= a\left(V(\Delta x_n) - v_n\right),& &n=1,\dots,N
\end{align}
where $a$ is the driver sensitivity and $V$ is the optimal velocity function. A common choice for $V$ \cite{Bando} is
\begin{gather*}
V(\Delta x)=\tanh(\Delta x - 2) + \tanh(2)
\end{gather*}

% SHOW GRAPH of V and V'
\begin{figure}[!h]
\lm
\begin{center}
\includegraphics[width=3in]{vopt}
\end{center}
\caption{\label{fig:vopt} Optimal velocity function and its derivative.}
\end{figure}

Using this model, we can study the stability of uniform traffic flow.

\subsection{Linear Stability Analysis}
It is clear that the OVM equations of motion are satisfied when there is uniform traffic flow, i.e. when all cars have headway $L/N$ and velocity $V(L/N)$. In terms of car positions, this can be expressed as
\begin{gather}
x_n^*=bn + V(b)t
\intertext{where}
b=\frac{L}{N}
\end{gather}
This represents a fixed point in headway-velocity space. To study the stability of this fixed point, we express $x_n$ as the uniform flow steady state $x_n^*$ plus some perturbation $y_n$
\begin{gather}
x_n=x_n^*+y_n.
\end{gather}
Linearizing (\ref{ovm1}) and (\ref{ovm2}) and observing that $\dot{y}_n=\dot{x}_n$ and $\ddot{y}_n=\ddot{x}_n$ gives us the linearized equation for $y_n$
\begin{gather}
\label{ovml} \ddot{y}_n = a\left(f\Delta y_n - \dot{y}_n \right)
\intertext{where $f$ is the derivative of $V$ at the uniform flow headway $b$}
f=V'(b).
\end{gather}
We solve (\ref{ovml}) by considering as solutions the time-evolving discrete Fourier modes
\begin{gather}
y_k(n,t)=\exp\left(i\alpha_k n + zt\right)\\
\alpha_k = \frac{2\pi}{N}k (k=0,1,\dots,N-1)
\intertext{where}
z=u+iv
\intertext{and $u$ and $v$ are real.}
\end{gather}
Plugging $y_k(n,t)$ into (\ref{ovml}), we get a condition on $a,z,f$ and $\alpha_k$:
\begin{gather}
\label{zcond} z^2 + az - af\left(e^{-i\alpha_k} - 1\right) = 0
\end{gather}
Each mode $e^{i\alpha_kn}$ represents a spatial wave of car positions (relative to uniform flow) and evolves in time according to $z$. The uniform flow fixed point is stable whenever each of the $N$ spatial modes decays, i.e. whenever the real part of $z$ is negative for all $k$. Let us characterize the values of $a$ and $f$ for which this is the case. Expanding (\ref{zcond}) and treating the real and imaginary parts separately, we get
\begin{gather}
\label{stbl1} u^2 + au + af(1 - \cos(\alpha_k) ) - v^2\\
\label{stbl2} 2uv + av + af\sin(\alpha_k) = 0. 
\end{gather}
Solving (\ref{stbl1}) for $u$ and requiring $u<0$ gives
\begin{gather}
u = \frac{-a \pm \sqrt{a^2 - 4(af(1-\cos(\alpha_k))-v^2)}}{2} < 0
\end{gather}
\begin{align}
 a^2 - 4(af(1-\cos(\alpha_k))-v^2) &< a^2\\
 - 4(af(1-\cos(\alpha_k))-v^2) &< 0\\
\label{stbl3}  af(1-\cos(\alpha_k)) &> v^2
\end{align}
In (\ref{stbl3}), $v$ is unknown, but solving (\ref{stbl2}) for $u$ and requiring $u<0$ will give us a bound on $v$. From (\ref{stbl2}), we get
\begin{gather}
u = \frac{-af\sin(\alpha_k)-av}{2v} < 0.
\end{gather}
Rearranging, we arrive at
\begin{gather}
-\frac{f\sin(\alpha_k)}{v} < 1.
\end{gather}
Replacing $v$ with its absolute value yields
\begin{align}
|v|&>-f\sin(\alpha_k),& &v \geq 0\\
|v|&>f\sin(\alpha_k),& &v<0
\end{align}
and finally, gives a bound on $v^2$
\begin{gather}
\label{stbl4} v^2 > f^2\sin^2(\alpha_k).
\end{gather}

Combining (\ref{stbl3}) and (\ref{stbl4}) results in
\begin{align}
af(1-\cos(\alpha_k)) &> f^2\sin^2(\alpha_k)\\
 f &< \frac{a(1-\cos(\alpha_k))}{\sin^2(\alpha_k)}\\
 f &< \frac{a(1-\cos(\alpha_k))}{1-\cos^2(\alpha_k)}\\
 f &< \frac{a(1-\cos(\alpha_k))}{(1+\cos(\alpha_k))(1-\cos(\alpha_k))}\\
\label{stbl5}  f &< \frac{a}{2\cos^2(\frac{\alpha_k}{2})}.
\end{align}
Recalling that the uniform flow is not stable unless (\ref{stbl5}) is true for all $k$, we get a simple necessary and sufficient stability condition on $a$ and $f$:
\begin{gather}
f < \frac{a}{2}
\end{gather}

This result is summarized visually in Figure \ref{fig:stblregion}.

\begin{figure}[!h]
\lm
\begin{center}
\includegraphics[width=3in]{stblregion}
\end{center}
\caption{ \label{fig:stblregion} The stability of the uniform flow fixed point is characteried by a critical line in the $(f,\alpha)$ plane in polar coordinates. Here, $\alpha$ is taken to be a continuous parameter for simplicity.}
\end{figure}

\section{Analysis of Control Policies}
Suppose that we can control a subset of the cars. In this section, we propose ???????HOW MANY, WHAT KIND, ETC????????? control policies that enlarge ????????WORDING????????? the stable region of the uniform flow.  

\subsection{Control Using Caution Functions}
Let us call the cars we can control {\em active} and the rest of the cars {\em passive}. Let $\mathcal{A}$ be the set of active car indices and $\mathcal{P}$ be the set of passive car indices. 

% TRANSITION

Consider the following control policy for active cars. Whenever an active car has headway $\Delta x$, its driver pretends that the headway is actually $c(\Delta x)$, where $c$ is a {\em caution function} that is nonnegative, sublinear, monotonically increasing, and differentiable on $(0,\infty)$. The car then follows the optimal velocity dynamics as usual. The modified dynamics are
\begin{align}
\dot{x}_n &= v_n,& &n=1, \dots, N\\
\dot{v}_n &= a\left(V(\Delta x_n) - v_n \right),& &n \in \mathcal{P}\\
\dot{v}_n &= a\left(V(c(\Delta x_n)) - v_n \right),& &n \in \mathcal{A}.
\end{align}
or in headway-velocity space,
\begin{align}
&\dot{\Delta x}_n = v_{n-1}-v_n,& &n=1,\dots, N\\
&\dot{v}_n = a\left(V(\Delta x_n) - v_n \right),& &n \in \mathcal{P}\\
&\dot{v}_n = a\left(V(c(\Delta x_n)) - v_n \right),& &n \in \mathcal{A}
\end{align}
Now let us find the fixed point of these dynamics in headway-velocity space and analyze its stability. Setting $\dot{\Delta x}_n$ and $\dot{v}_n$ to 0, we get
\begin{align}
&\label{cfp1} v_{n-1}^* = v_n^*,& &n=1, \dots, N\\
&v_n^* = V(\Delta x_n^*),& &n \in \mathcal{P}\\
&v_n^* = V(c(\Delta x_n^*)),& &n \in \mathcal{A}
\end{align}
Let us now consider two adjacent cars $p$ and $a$, with the $p$th passive and the $a$th active. Because their velocities must be equal we have 
\begin{gather}
V(\Delta x_p^*)=V(c(\Delta x_a^*)).
\intertext{For monotonic $V$, this implies}
\label{cfp2} \Delta x_p^*=c(\Delta x_a^*).
\end{gather}
Because adjacent cars of the same type have the same velocity, and hence headway, all the passive cars have headway $\Delta x_p^*$ and all the active cars have headway $\Delta x_a^* = c(\Delta x_p^*)$. Equations (\ref{cfp1}) and (\ref{cfp2}), together with the constraint $\sum_{n=1}^N \Delta x_n = L$ then determine the fixed point.

To linearize around the fixed point, it will prove useful to represent the state as the deviation of each headway from the desired headway, and the difference in velocities of adjacent cars
\begin{gather}
y_n = x_{n-1} - x_n - \Delta x_n^*\\
w_n = v_{n-1} - v{n}
\end{gather}
giving dynamics
\begin{gather}
\dot{y}_n = w_n, \; n=1,\dots, N\\
\dot{w}_n = a\left(V_{n-1}(y_{n-1} + \Delta x_{n-1}^*) - V_n(y_n + \Delta x_n^*) - w_n \right)
\end{gather}
where $V_n = V$ for $n \in \mathcal{P}$ and $V_n = V \circ c$ for $n \in \mathcal{A}$. Note that the $y$ here is different from the $y$ used in the uncontrolled case. The linearized dynamics are
\begin{align}
\label{cfdyn} \ddot{y}_n &= a(f_{n-1}y_{n-1} - f_n y_n - \dot{y}_n)
\end{align}
where
\begin{align}
f_n &= f_p = V'(\Delta x_p^*), \; n \in \mathcal{P}
\intertext{and}
f_n = f_a &= V'(c(\Delta x_a^*))c'(\Delta x_a^*), \; n \in \mathcal{A}\\
&= V'(\Delta x_p^*) c'(\Delta x_a^*)\\
&= f_p \sigma.
\end{align}
Note that we cannot assume solutions of the form $y_k(n,t)=\exp\left(i\alpha_kn + zt\right)$ like we could in the uncontrolled case. To see this, observe that plugging $y_k(n,t)$ into the four cases of the dynamics in Equation (\ref{cfdyn}) yields unsatisfiable conditions on $z$. Indeed, this is because $y_k(n,t)$ are eigenvectors of the linearized uncontrolled dynamics but not of the linearized controlled dynamics. \footnote{The issue here is that the the uncontrolled dynamics have only one type of car, and this makes the linearized system simple enough to allow one to guess that its eigenvectors are $y_k(n,t)$. The nonuniformity introduced by active cars makes it far more difficult to determine the eigenvectors of the linearized controlled system.}

Hence, we study stability using the {\em string stability} framework of \cite{Liang}, \cite{Konishi} and \cite{Yanakiev}. In this framework, we look at how disturbances in headway (relative to the steady-state headway) propagate between consecutive cars by investigating the transfer function of the dynamics in Equation (\ref{cfdyn})
\begin{gather}
s^2 Y_n(s) = a(f_{n_1}Y_{n-1}(s) - f_nY_n(s) - sY_n(s))\\
Y_n(s) = \frac{af_{n-1}}{s^2 + as + af_n}Y_{n-1}(s)\\
Y_n(s) = G_{n-1,n}(s)Y_{n-1}(s).
\end{gather}
To see what happens for a full cycle of propagation, we can relate $Y_N(s)$ to $Y_1(s)$ by writing
\begin{align}
Y_N(s) &= G_{1,N}(s) Y_1(s)\\
&= G_{1,2}(s) \dots G_{N-1,N}(s) Y_1(s).
\end{align}
The system is stable if and only if
\begin{enumerate}
\item for all $n$, $G_{n-1,n}(s)$ has no poles
\item $\|G_{1,N}(j\omega)\|_{\infty} := \displaystyle \sup_{\omega \in [0,\infty)} |G_{1,N}(j\omega)| \leq 1$.
\end{enumerate}
The first condition ensures that the system doesn't blow up due to a pole. The second condition ensures that disturbances in headway are not amplified indefiitely as cars go around the circlular road.

Let us compute the magnitude and sup-norm of $G_{n-1,n}(j\omega)$.
\begin{align}
|G_{n-1,n}(j\omega)| &= \sqrt{G_{n-1,n}(j\omega)G_{n-1,n}(-j\omega)}\\
&= \sqrt{\frac{a^2f_{n-1}^2}{(af_n - \omega^2)^2 + a^2\omega^2}}
\end{align}

There are four cases of $|G_{n-1,n}(j\omega)|$ depending on $f_n$ and $f_{n-1}$:
\begin{align}
|G_{a,a}(j\omega)| &= \sqrt{\frac{a^2f_p^2\sigma^2}{(af_p\sigma - \omega^2)^2 + a^2\omega^2}}\\
|G_{p,a}(j\omega)| &= \sqrt{\frac{a^2f_p^2}{(af_p\sigma - \omega^2)^2 + a^2\omega^2}}\\
|G_{a,p}(j\omega)| &= \sqrt{\frac{a^2f_p^2\sigma^2}{(af_p - \omega^2)^2 + a^2\omega^2}}\\
|G_{p,p}(j\omega)| &= \sqrt{\frac{a^2f_p^2}{(af_p - \omega^2)^2 + a^2\omega^2}}.
\end{align}
Here, we have abused notation to indicate the transfer functions between adjacent passive or active cars.
The amplitude of the full-cycle transfer function $G_{1,N}$ can then be written as
\begin{align*}
|G_{1,N}(j\omega)| = |G_{a,a}(j\omega)|^{N_{a,a}} &\cdot |G_{p,a}(j\omega)|^{N_{p,a}} \cdot \\ |G_{a,p}(j\omega)|^{N_{a,p}} &\cdot |G_{p,p}(j\omega)|^{N_{p,p}}
\end{align*}
where $N_{*,*}$ indicates the number of instances of each type of pair of adjacent cars.

Assuming no poles, a sufficient condition for stability is then
\begin{align*}
\|G_{a,a}\|_{\infty}^{N_{a,a}} \cdot \|G_{p,a}\|_{\infty}^{N_{p,a}} \cdot \|G_{a,p}\|_{\infty}^{N_{a,p}} \cdot \|G_{p,p}\|_{\infty}^{N_{p,p}} \leq 1.
\end{align*}
To compute the sup-norms of the $|G_{n-1,n}(j\omega)|$s, we make a further assumption about $a$ and $f_p$. Konishi \cite{Konishi} showed that for a system of passive cars, $|G_{n-1,n}(j\omega)|$ achieves only a single maximum at $\omega=0$ if $f < a/2$. This corresponds to $\partial |G_{n-1,n}(j\omega)|/\partial \omega$ having only one real root. Adapting this result to the mixed-car case gives $f_p < a/2$ and $f_p\sigma < a/2$, the latter of which is implied by the former due to the definition of the caution function. This allows us to compute the sup-norms simply by evaluating the amplitudes at $\omega=0$:
\begin{gather}
\|G_{a,a}\|_{\infty} = 1\\
\|G_{p,a}\|_{\infty} = 1/\sigma\\
\|G_{a,p}\|_{\infty} = \sigma\\
\|G_{p,p}\|_{\infty} = 1.
\end{gather}
It is clear then that for $f_p < a/2$, the system is stable:
\begin{align*}
&\|G_{1,N}\|_{\infty}&\\
&\leq \|G_{a,a}\|_{\infty}^{N_{a,a}} \cdot \|G_{p,a}\|_{\infty}^{N_{p,a}} \cdot \|G_{a,p}\|_{\infty}^{N_{a,p}} \cdot \|G_{p,p}\|_{\infty}^{N_{p,p}}& \\
&= 1^{N_{a,a}} \cdot \left(\frac{1}{\sigma}\right)^{N_{p,a}} \cdot \sigma^{N_{a,p}} \cdot 1^{N_{p,p}}& \\
&\leq 1.&
\end{align*}

This leads us to a key result: caution function control can increase the region of stability.\footnote{Note that the region of stability --- the region in paramter space for which the system is stable, is different from the region of {\em attraction} --- the region in state space of all initial conditions that convergence to the fixed point.} Observe that for a given car density $b$, caution function control results in the optimal headways 
\begin{gather}
\Delta x_p^* < b < \Delta x_a^*.
\end{gather}
For $b \leq 2$ (the inflection point of $V$), this implies
\begin{gather}
f_p = V'(\Delta x_p^*) < V'(b) = f
\end{gather}
This results in cases in which the uncontrolled system is unstable ($f > a/2$), but the caution-function-controlled system is stable ($f_p < a/2$). This phenomenon is illustrated in Figure \ref{fig:ctrstbl}. Because we only showed $f_p < a/2$ to be a sufficient condition, we cannot conclude anything about the relative stability of the controlled and uncontrolled systems if $b>2$. However, we show numerically in Section \ref{sec:numer} that caution function control has a stabilizing effect even when $b>2$. 

\begin{figure}[!h]
\begin{center}
\includegraphics[width=3in]{vopt_caution}
\includegraphics[width=3in]{ctrstbl}
\end{center}
\caption{ \label{fig:ctrstbl} The caution function pushes $V'$ down so that $f_p$ moves from the unstable region to the stable region.}
\end{figure}

\subsection{Control Using Velocity Matching}
Another control strategy is for the active cars to try to match the velocity of the preceding vehicle as well as the optimal velocity prescribed by the headway. The equations of motion in headway-velocity space become
\begin{align}
&\dot{\Delta x}_n = v_{n-1} - v_n,& &n=1, \dots, N\\
&\dot{v}_n = a\left(V(\Delta x_n) - v_n \right),& &n \in \mathcal{P}\\
&\dot{v}_n = a\left(V(\Delta x_n) - v_n \right) + k(v_{n-1}-v_n),& &n \in \mathcal{A}
\end{align}
Observe that the fixed point is $\Delta x_n^* = b, v_n = V(b)$ for $n=1,\dots,N$, the same as that of the uncontrolled system. Let us investigate its region of stability and how it compares to that of the uncontrolled system. As before, we derive the linearized equations of motion
\begin{align}
\ddot{y}_n &= a(f\Delta y_n - \dot{y}_n),& &n \in \mathcal{P}\\
\ddot{y}_n &= a(f\Delta y_n - \dot{y}_n) + k(\dot{y}_{n-1} - \dot{y}_n),& &n \in \mathcal{A}\\
\end{align}
and plug in solutions $y_k(n,t)=\exp\left(i\alpha_kn + zt\right)$. This gives the conditions
\begin{gather}
\label{zcondvm1} z^2 = a(f(e^{-i\alpha_k} - 1) - z) = 0\\
\label{zcondvm2} z^2 = a(f(e^{-i\alpha_k} - 1) - z) + kz(e^{-i\alpha_k}-1) = 0
\end{gather}
Equation (\ref{zcondvm1}) gives rise to the familiar $f<\frac{a}{2\cos^2(\frac{\alpha}{2})}$. The real and imaginary parts from (\ref{zcondvm2}) are
\begin{gather}
u^2 + u(a + k(1-c)) + af(1-c) - v^2 - kvs = 0\\
2uv - vc + av + afs + kus + vk = 0
\end{gather}
where $s=\sin(\alpha_k)$ and $c=\cos(\alpha_k)$.
Solving for $u$ and requiring $u<0$, we arrive at
\begin{gather}
af(1-c) > v^2 + vks\\
\frac{v(k(c-1)-a) - afs}{2v + ks} < 0.
\intertext{Rewriting gives}
\label{vmstbl1} af(1-c) > \left(v+\frac{ks}{2}\right)^2 - \frac{k^2s^2}{4}\\
\label{vmstbl2} \frac{v(k(c-1)-a) - afs}{v + \frac{ks}{2}} < 0.
\end{gather}
We replace $v + \frac{ks}{2}$ in Equation (\ref{vmstbl2}) with $|v + \frac{ks}{2}|$ and rearrange to get
\begin{align}
v &> \frac{afs}{k(c-1)-a},& v + \frac{ks}{2} > 0&\\ 
v &< \frac{afs}{k(c-1)-a},& v + \frac{ks}{2} < 0&
\end{align}
where the signs of the inequalities have flipped due to the negativity of $k(c-1)-a$. Adding $\frac{ks}{2}$ to both sides yields
\begin{align}
v + \frac{ks}{2} &> \frac{afs}{k(c-1)-a} + \frac{ks}{2},& v + \frac{ks}{2} > 0&\\ 
v + \frac{ks}{2} &< \frac{afs}{k(c-1)-a} + \frac{ks}{2},& v + \frac{ks}{2} < 0&
\end{align}
or equivalently
\begin{gather}
\left|v + \frac{ks}{2}\right| > \frac{afs}{k(c-1)-a} + \frac{ks}{2}.
\intertext{Combining this with (\ref{vmstbl1}) we have}
af(1-c) > \left(\frac{afs}{k(c-1)-a} + \frac{ks}{2}\right)^2 - \frac{k^2s^2}{4}
\intertext{After expanding and rearranging, we get a quadratic inequality in $f$}
f\left(\left(\frac{as}{k(c-1)-a}\right)^2 f + \frac{aks^2}{k(c-1)-a} + a(c-1)\right) < 0
\intertext{Because $f>0$ due to our choice of optimal velocity function, the inequality for $f$ becomes a linear one}
\left(\frac{as}{k(c-1)-a}\right)^2 f + \frac{aks^2}{k(c-1)-a} + a(c-1) < 0.
\intertext{Expanding and using the the half-angle trigonometric formulas gives}
f<\frac{k}{c_{1/2}^2}\left(\frac{2ks_{1/2}^2}{a} + s_{1/2}^2 + 1\right) + \frac{a}{2c_{1/2}^2}
\intertext{Interestingly, the other condition for stability $f<\frac{a}{2c_{1/2}^2}$ implies the one just derived, so the final condition on $f$ for velocity matching control is just}
f<\frac{a}{2\cos^2(\frac{\alpha_k}{2})},
\intertext{for all $\alpha_k$, or}
f<\frac{a}{2}
\end{gather}
--- the same condition as the uncontrolled system. Therefore, the velocity matching control policy has the exact same region of stability as the uncontrolled system.

Despite not enlarging the region of stability, the policy is still useful. In section \ref{sec:numer}, we show numerically that velocity matching control results in dynamics with faster convergence and a larger region of attraction than the dynamics of the uncontrolled system. %TODO: MAKE SURE ROA PART IS ACTUALLY TRUE

% TODO: KEEP ANY OF THIS?
It is impossible to increase the region of stability for the equal headway uniform flow unless all cars are active (but wait, isn't it only a sufficient rather than necessary condition? Pretty sure I can reverse all the steps.... But, also, in simulation, every second car being active works...even though we're not in the stable region. Nope, it still oscillates, but low spatial freq). The only way to increase stability is to change the fixed point by warping the steady state headways. However, it might be that some controllers give better regions of attraction. (Why might that be the case?)

\section{Numerical Simulations}
\label{sec:numer}

Demonstrate stability vs instability of uncontrolled system
\begin{figure}[!h]
\lm
\begin{center}
\includegraphics[width=3in]{instability}
\end{center}
\caption{ \label{fig:instability} For sensitivity $a<2f$, the uniform traffic flow configuration is unstable. Starting close to uniform flow, the system is pushed away toward a self sustaining traffic jam.}
\end{figure}


\begin{figure}[!h]
\lm
\begin{center}
\includegraphics[width=3in]{smoothed}
\end{center}
\caption{ \label{fig:smoothed} For sensitivity $a>2f$, the uniform traffic flow configuration is stable. Starting away from uniform flow, the disturbances in the vehicle velocities and headways are smoothed out.}
\end{figure}

Also plot amplitude of Fourier transform over time. Show merging of traffic jams.

Demonstrate instability of uncontrolled system and stabilizing effect of caution function control policy. Amplitude of Fourier transform over time. Different notion of convergence.

For velocity matching policy: 1) Show the robustness of stability when all cars are active (pick an a for which the uncontrolled system is clearly unstable). 2) Show that if even one car is not active, the fixed point is not stable.

Compare the rates of convergence of uncontrolled system, velocity matching control, and caution function control (though you need to actually substract the (different) steady state)

\begin{figure}[!h]
\lm
\begin{center}
\includegraphics[width=3in]{convscl5}
\end{center}
\caption{ \label{fig:convscl5} Convergence rates for different control policies represented by the time evolution of the $\ell^2$ norm of the discrete Fourier transform of headways relative to the fixed point headways. There are 100 cars on a road of circumference 200, and the car sensitivities are $a=2.1$ (just above the stability threshold for the uncontrolled system). All the systems are stable but the controlled systems converge much faster. There are 20 active cars. A high-gain velocity matching controllers vastly outperforms the caution function controllers.}
\end{figure}

\begin{figure}[!h]
\lm
\begin{center}
\includegraphics[width=3in]{convscl25}
\end{center}
\caption{ \label{fig:convscl25} Convergence rates for different control policies (see Figure \ref{fig:convscl5}) There are 4 active cars. The smaller number of active cars allows for higher steady-state headways for the active cars and lower steady-state headways for the passive cars, enlarging the region of stability (c.f. Figure \ref{fig:ctrstbl}). The result is that $a=2.1$ is well into the stable region for the caution function controllers, causing much faster convergence.}
\end{figure}








\begin{comment}
% describe the algorithmic approach you selected and why
\section{Algorithmic Approach}

LQR cost doesn't really handle rewarding high velocity (though it can specify an arbitrarily high desired velocity). SGD can do any objective function.

LQR doesn't know about the constraint that all inter-car distances have to sum to the circumference. Hence, we have to remove the Nth spacing and its derivatives from the state in order to manually enforce the constraint.

\section{Results}

\subsection{Circular Topology}

\paragraph{No delay} Traffic eventually smooths out by itself but it takes a very long time. Adding active cars dramatically reduces the time it takes to smooth out traffic. 

Using LQR: Because the LQR objective prescribes a desired distance between cars, and cars will naturally want to spread out evenly over the whole circle, the active cars end up picking up the ``slack'' in order to make all the distances add up to the circumference of the circle. (This is not the whole story. When the circumference is less than the total sum of the desired spacings, LQR optimizes for cars having the same velocity and takes a penalty on desired distances.)

An interesting observation is that with a small number of active cars, this act of picking up slack can make the distances in front of the active cars oscillate, leading to negative distances. As more active cars are added, each individual car is less burdened with making the distances sum to the cirucmference, and no distances ever become negative.

The uncontrolled system is only stable for certain gains (how do you know which ones? Make a distinction between stability=smoothness and stability=things not blowing up. That is, self-sustaining traffic is stable in a mathematical sense, but velocities blowing up is not). However, the addition of active cars stabilizes systems that would have otherwise been unstable.

\paragraph{Delay}

Delay appears to make the system take even more time to smooth out (does it? you changed the timestep --- watch out!). However, I could not get it to do self sustaining traffic.



Linear Topology


% list any surprises / difficulties that you encountered (so that we can all learn from them)
\section{Discussion}  

The qualitative behavior of traffic models is difficult to understand. Some models seem to form shocks and rarefactions and others seem to not. It is difficult to tell whether this is due to the parameter setting or an inherent limitation in the model.

Aw Rascle model seems more aggressive. It is also nonlinear. Hence shocks?

Numerical Instability (preventing collisios but not updating velocities and accelerations to 0). Leads to NaN scores for sgd.

Need small deltas for sgd for small ks.

Need more clever penalty function, since cars can be | o o o o o o o o o           o o o | (good, but high penalty because of gap) or | o ooo o o ooo o oo o o o ooo oo  oo| (bad but good penalty becase of no gap)

How to handle infinite cost for SGD. For example, if we have a 1/avgvelocity term in the cost function and all the cars stop, the cost will be infinite. The cars will all stop in finite time if the active gains are set to zero.

Integrating the total cost over time might not be the best thing to do. What we want is the cost in the long run. Otherwise, systems that smooth out can often do far worse overall than systems that don't.

Key contribution of the approach: Control and verification of non-analytical systems.
\end{comment}

\end{document}
